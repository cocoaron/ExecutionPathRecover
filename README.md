# ExecutionPathRecover

ExecutionPathRecover is a firmware update path extracting module. It is derived from ChkUp(https://github.com/WUSTL-CSPL/ChkUp). The project contains Ghidra v10.1.2, PathUp, and firmwares. The firmware directory includes firmware file system that is extracted using Binwalk. Ghidra is utilized by PathUp to parse binary data.

### PathUp fixes 

PathUp improves upon ChkUp through enhanced binary entry file search. ChkUp has bias on web entry files over other file format. (e.g. shell, binary, etc.) However, current implementation of ChkUp shows that due to its bias, it incorrectly implemented entry file search for binary files. When parsing through firmware with no web entry files, ChkUp creates multiple errors such as following logs. Moreover, binary entry file search simply relied on ASCII strings that can be found through the compile binaries. This limited the context of binary search as it loses important information such as functions and parameters. Ghidra was used to correctly parse through binary files and find correct path. Detailed information can be found in the paper.

![image](https://github.com/user-attachments/assets/4a366f07-6a83-4493-8f27-ed9e3b715c5e)
![image](https://github.com/user-attachments/assets/1248aa4f-efbe-4a8f-b414-611f7c1d0ac4)

### How to use PathUp

PathUp can extract program execution paths from a firmware file system. It is recommended to run PathUp in Ubuntu 20.04. If following commands fail, please refer to README file inside PathUp directory. Dependencies that are required to run the project are also inside PathUp's README file. The project will require enough disk space about 15GB. Following permissions are required to run the program.

Given script will install all dependencies required for the project. The dependencies will ask for sudo permissions. After installing all requirements. It will run update path extrator modules 3 times for each different firmwares. 

#### Available Firmwares

All available firmwares in the projects are located in /firmware/extracted directory.
* TP-Link: WA801N(in script), WR940N
* Netgear: WNR1000(in script), WPN824EXT
* Reolink: RLC-410W(in script)

```
git clone https://github.com/cocoaron/ExecutionPathRecover.git
cd ./ExecutionPathRecover
chmod +x ./run.sh
chmod +x ./PathUp/pathup_run.sh
chmod +x ./ghidra_10.1.2_PUBLIC_20220125/ghidra_10.1.2_PUBLIC/support/launch.sh
chmod +x ./ghidra_10.1.2_PUBLIC_20220125/ghidra_10.1.2_PUBLIC/support/analyzeHeadless
./run.sh
```
----------------------------------------------------------------------------------------------------------------------

### Input Example
  ```
  wa801nv1_en_3_12_6_up_bin_extracted (file system directory)
  ```
### Output Example
#### ufg-SoftwareUpgradeRpm.pkl  
![image](https://github.com/user-attachments/assets/7f9129e8-459f-4d2f-84af-9447c4877aa7)

#### results.json  
  ```
{"html": {"($WorkinDirectory)/ExecutionPathRecover/firmware/extracted/wa801nv1_en_3_12_6_up_bin_extracted/100000/squashfs-root/web/userRpm/SoftwareUpgradeRpm.htm": {"($WorkinDirectory)/ExecutionPathRecover/firmware/extracted/wa801nv1_en_3_12_6_up_bin_extracted/100000/squashfs-root/web/userRpm/SoftwareUpgradeRpm.htm": {"filetype": "html", "caller": "", "callway": "", "callee": ["($WorkinDirectory)/ExecutionPathRecover/firmware/extracted/wa801nv1_en_3_12_6_up_bin_extracted/100000/squashfs-root/usr/bin/httpd"], "keywords": {}, "function": {"checksum": [], "device": [], "version": [], "signature": [], "write": [], "reboot": [], "delivery": []}}, "($WorkinDirectory)/ExecutionPathRecover/firmware/extracted/wa801nv1_en_3_12_6_up_bin_extracted/100000/squashfs-root/usr/bin/httpd": {"filetype": "elf", "caller": "/mnt/c/Users/min99/project/ExecutionPathRecover/firmware/extracted/wa801nv1_en_3_12_6_up_bin_extracted/100000/squashfs-root/web/userRpm/SoftwareUpgradeRpm.htm", "callway": "IPC", "callee": ["/mnt/c/Users/min99/project/ExecutionPathRecover/firmware/extracted/wa801nv1_en_3_12_6_up_bin_extracted/100000/squashfs-root/etc/rc.d/iptables-stop"], "keywords": {"para": [], "func": ["Firmware.htm"], "pattern": ["wps_os_version=%s", "overTime", "wlanSecurityOnSaveRpmHtm: Get wrong vap index %d !", "driver=%s", "check_filesize", "isPingOver", "memPoolCheck: end-of-pool overrun!", "get_miniserver_sockets", "md5_make_digest", "update_config=1", "dhcpServerStart", "C.4wmbObjectResolver", "apModeOnSaveRpmHtm", "Usage:\t%s [-krfhv] [--help] [--version]", "igdUpdateAPStatus", "wmConvertHex2Dec", "wmConvertNumberToStrSize", "igdUpdateWANAccessType", "Username and password are successfully updated", "dhcp server not running", "igdUpdateExternalPort", "HFREE_UPDATE", "<H2>Permission denied: Server cannot write to file</H2> terminating...", "TDDP:Get cmd executed over.", "md5Key", "oversubscribed dynamic bit lengths tree", "function parameters overflow", "web_server_destroy", "igdUpdatePortMappingProtocol", "swGetPingLastOverTime", "wmConvertTypeToInfo", "wmConvertEnum", "TDDP: Config MAC over. ", "<H2>Error: Server cannot parse multipart header</H2> terminating...", "Internal Server Error", "igdUpdateDefaultConnectionService", "/userRpm/UpdateTemp.htm", "updateDigest", "igdUpdateOutMessage", "wmBufferUpdate: null data ptr", "============Firmware version check failed=============", "igdUpdateExternalIPAddress", "MD5_Final", "wps_version=%s", "wmnetTcpServerOpen", "httpServerUncompress", "web_server_set_root_dir", "tl_setSysLogServer", "connectToServer: failed", "wmBufferUpdate: bad buffer", "wmnetTcpServerOpen: failed", "Failed to create semaphr", "Firmware upgrade succesful", "wlanNetworkOnSaveRpmHtm", "wmConvertNumberToStr: null buffer ptr", "buffer overrun", "SERVER_PROTOCOL", "The transmitted file was not stored on the server", "wmConvert: unable to convert OID to string", "Fail to Connect the mail server.", "Averate Wait in Low Priority Q in milliseconds: %lf", "startupDelay", "wmbTableColumnLengthUpdate", "UpnpSendAdvertisement", "ip_table_update", "igdUpdateWLANEventMAC", "wmBufferUpdate", "wmConvert: buffer too small", "\t[-f, --freeup]\tthis parameter allows httpd can update any firmware.", "UpnpEnableWebserver", "IPC:unsupported version", "SYS_USRCFG_VERSION", "wmConvertReverseString", "snmpUpdateFirewall", "wlanAdvOnSaveRpmHtm", "Average Wait in High Priority Q in milliseconds: %lf", "CheckOtherHTTPHeaders", "wmbObjectResolver: invalid object", "@wlanNetworkOnSaveRpmHtmforWzd", "swWlanloadDriver", "httpSoftUpdateRpmsInit", "wmConvert: dest buffer too small", "SERVER", "igdUpdatePortMappingLeaseDuration", "igdUpdateInternalPort", "DEV_MODOL_VER", "StartMiniServer", "igdUpdateConnectionStatus", "MD5_Init", "<HTML><TITLE>Access Verification</TITLE><BODY><CENTER><H1>ACCESS VERIFICATION</H1></CENTER>", "delivery: %s", "getUsrCfgVersion", "Everywhere", "/userRpm/LanDhcpServerRpm.htm", "bool conversion not handled", "failed socket creation", "wmConvertIntToString", "TDDP: Set cmd executed over.", "</specVersion>", "HFORWARD_VIRTUAL_SERVER_SIZE", "dns_server=0.0.0.0", "tddp_versionOneOpt", "driver=madwifi", "wmConvertStrSize", "wmConvertStrToOid: no data", "-->startupdelay : %ld", "HARDWARE_VERSION", "wmConvert: invalid data type", "httpServerName", "wmConvertSecsToStr", "swGetTracertLastOverTime", "no conversion!", "wlan_GroupKeyUpdateWpa", "AutoAdvertise", "igdUpdatePortMappingDescription", "\t[-v, --version]\tversion", "\t</specVersion>", ".gnu.version", "igdUpdateRemoteHost", "syslog_mail_veri", "checkTimeTable", "dnsserver", "sysVersionInfoInit", "wmConvertBoolToStr", "EAP-WPS-PBC-OVERLAP", "igdUpdatePortMappingNumberOfEntries", "igdUpdateMessage", "Error specifying webserver root directory -- %s: %d", "igdUpdateVar", "wmConvertDataTypeName", "wmConvertOctetsToStr", "HTTP Version Not Supported", "advertiseAndReplyThread", "md5_verify_digest", "updateLanDynIp", "igdUpdatePossibleConnectionTypes", "httpFirmwareUpdateTempRpmHtm", "UpnpGetServerPort", "=============go to start wps in universal repeater mode=========", "icmpVerifyId", "<?xml version=\"1.0\"?>", "; VERSION=1", "httpServerIdentification", "MakeVap: Wireless driver didn't loaded yet !", "auth_server_addr=%s", "VERSION=0x10", "upgradeFirmware", "wmConvertStrToNumber", "httpServerStart", "UpnpSetWebServerRootDir", "/incoming/Firmware.htm", "H-Ver = %s : S-Ver = %s", "AdvertiseAndReply", "oversubscribed literal/length tree", "/userRpm/ConfUpdateTemp.htm", "DHCP_SERVER", "wlan_GroupKeyUpdate", "failed reading file", "bWebServerState", "SystemLogSaveRpmHtm", "failed to read pin from flash", "# H-Ver = %s : S-Ver = %s", "incompatible version", ".gnu.version_r", "httpFirmwareUploadRpmHtm", "igdUpdateLayer1UpstreamMaxBitRate", "\tversion=0x10", "LanDhcpServerRpmsInit", "ping_verbos_result", "igdUpdateWLANResponse", "wmConvertStrToOid: buffer too small", "<H2>Permission denied: Server cannot create/open file</H2> terminating...", "eap_server=%d", "wmConvert: missing src data", "TDDP: Config PIN over. ", "signal caught during open.", "wmConvertStrTo", "wmConvertIsNumber", "ssdp:discover", "httpDhcpServerInit", "wmConvertValidate", "swSnmpUpdateFirewall", "<HR><H3>NOTE:</H3>Don't worry if the authorization line is empty and the GID is &quot;(null)&quot;. This could happen if you didn't invoke this RPM inside a protected URL tree. Some browsers like Netscape remember for which URL subtrees a server requested authentication and do NOT send an authorization string if they assume that this URL is unprotected.<P>In the <TT>tutorial</TT> all URLs below \"/protected/\" are protected and therefore it might happen that you can only see your authorization string if you invoke this RPM with an URL starting with \"/protected/\"!<P>", "Validation is not supported by smtp mail server.", "<H2>Error: Server cannot read from client</H2> terminating...", "SERVER_SOFTWARE", "<?xml version=\"1.0\" encoding=\"UTF-8\"?>", "SERVER: ", "wmConvertDec2Hex", "igdUpdateWLANEvent", "wmConvertLongToStr", "fwrite", "md5 verify failed", "dhcp server disabled", "isFreeUpdate", "tddp_versionTwoOpt", "igdUpdateDeviceInfo", "\t<specVersion>", "wmbObjectResolver", "igdUpdateLayer1DownstreamMaxBitRate", "<H2>Permission denied: Server cannot close file</H2> terminating...", "/userRpm/FirmwareUpdateTemp.htm", "http_CalcResponseVersion", "igdUpdateNATEnabled", "oversubscribed distance tree", "Firmware version check failed", "HPRODUCT_VERSION", "updateLanParams", "TDDP: Heartbeat cmd executed over. ", "<allowedValue>ERROR_SERVER_OUT_OF_RESOURCES</allowedValue>", "Verify", "<specVersion>", "getSoftWareVersion", "tracert_verbos_result", "wmConvertIPToStr", "ServiceAdvertisement", "igdUpdateInternalClient", "igdUpdateWLANEventType", "wmConvert: null dest buffer", "DHCP server started", "wmConvertStrToIP", "auth_server_port=%d", "wmConvertStrToOid: null buffer", "DeviceAdvertisement", "TDDP: Special cmd executed over. ", "Server: %s", "wmConvertNumberToStr", "ipt_update", "wmConvertStr", "igdUpdateLastConnectionError", "LanDhcpServerRpm", "eapol_version=%d", "wmConvertMacAddrToStr", "wmbObjectRedo: overwriting cookie", "Average Wait in Med Priority Q in milliseconds: %lf", "MIME-Version: 1.0", "upgradeFirmware: return error!", "ucUpdateSysAppFile", "igdUpdateUptime", "getProductVer", "CHECKED", "wmConvertMacAddrToStr: buffer too small", "wlanNetworkOnSaveRpmHtmforWzd", "md5Key_bootloader", "igdUpdateMaximumActiveConnections", "SERVER_NAME", "devModelVerGet", "\tos_version=0x00000001", "igdUpdateConnectionType", "wmConvert", "ip address (version 6)", "wmConvertStrNumCmp", "sysAppUpdateWithBootloader", "wmConvert: buffer inadequate", "wmnetTcpServerOpen %d", "auth_server_shared_secret=%s", "wmbObjectCookieSet: overwriting cookie!", "wmConvertGetEnumCount", "wmConvertToStr", "igdUpdatePortMappingEnabled", "dnsserver2", "wmConvertOidToString", "wmConvertStrToInt: null ptr", "dhcpserver", "web_server_init", "web_server_callback", "protocol version error", "igdUpdateAPSettings", "eap_server=1", "igdUpdateInMessage", "igdUpdateRSIPAvailable", "LanDhcpServerRpmHtm", "wmConvertStrToOid", "SERVER_PORT", "wmConvertStrToInt: invalid data", "wmConvertStrToEnum", "httpServerCreate", "wmConvertStrToList", "sysAppUpdate", "igdUpdatePhysicalLinkStatus", "wmBufferUpdate: already has static data", "call httpServerCreate first", "wmConvertStrToOid: illegal digit", "igdUpdateSTASettings", "wmConvertStrToMacAddr", "CheckBoxManager", "MD5_Update", "wmConvertStrToInt: no data", "libUpnp/src/webserver.c", "*******************************go to unload driver in repeater monitor thread.***********", "buffer overflow", "\"ssdp:discover\"", "wlanPwdOnSaveRpmHtm", "igdUpdateSTAStatus"], "msg": []}, "function": {"checksum": ["MD5_Update:1000eb9c", "MD5_Update:00493d54", "MD5_Update:00493e9c", "MD5_Update:00493fa4", "MD5_Update:00494088", "MD5_Update:004940a0", "MD5_Update:004940e8", "MD5_Update:00494100", "zlib_z_crc32:1000f32c", "zlib_z_crc32:0041fbb4", "zlib_z_crc32:0044542c", "zlib_z_crc32:0041eebc", "zlib_z_crc32:0041f504", "zlib_z_crc32:0041f5fc", "zlib_z_crc32:0041f5ac", "zlib_z_crc32:0044564c", "zlib_z_crc32:004456ac", "zlib_z_crc32:0044577c", "zlib_z_crc32:0041f820"], "device": ["getProductId:0046d1ec", "getProductId:1000f428", "getProductId:0046d200", "getProductId:00415c20", "getProductId:004769d4", "getProductId:0047bdb8", "getProductId:0047bc48", "getProductId:00475af4", "getProductId:004739e0", "getProductId:00473c1c", "getProductId:00473a84", "getProductId:00478ae8", "getProductId:00478ad4", "getProductId:00477c28", "getProductId:00486b14", "getProductId:00486e10", "getProductId:00477e48", "getProductId:0048b6fc", "getProductId:00482dbc", "getProductId:00482e00", "getProductId:00474f50", "getProductId:00471e64", "getProductId:00471fdc", "getProductId:00481f8c", "getProductId:00482018", "getProductId:00482640", "getProductId:004825ec", "getProductId:00482098", "getProductId:00487fc0", "getProductId:00490098", "getProductId:0047222c", "getProductId:00472250", "getProductId:00472274", "getProductId:00472298", "getProductId:004722bc", "getProductId:004801c0", "getProductId:00472360", "getProductId:00472380", "getProductId:004723a0", "getProductId:004723c0", "getProductId:004723e0", "getProductId:0047a4c8", "getProductId:004950b4", "getProductId:0047244c", "getProductId:0047246c", "getProductId:0047248c", "getProductId:004724ac", "getProductId:004724cc", "getProductId:004815f4", "getProductId:00474554", "getProductId:0045ae74", "getProductId:0045ae14", "getProductId:00472b38", "getProductId:0047b6b8", "getProductId:0048172c", "getProductId:004816fc", "getProductId:00474af4", "getProductId:00482ae8", "getProductId:00482a5c", "getProductId:00482b74", "getProductId:00482c6c", "getProductId:004827b0", "getProductId:0047879c", "getProductId:00478970", "getProductId:00415838", "getProductId:0048195c"], "version": ["getProductVer:1000eba8", "getProductVer:0048b71c", "getProductVer:004950d0"], "signature": [], "write": ["flash_capability:1000ee84", "flash_capability:0048b4c0", "ap81_write_mac_flash:00495480", "ap81_write_mac_flash:1000ef68", "ap81_write_mac_flash:00495494", "ap81_read_pin_flash:0049549c", "ap81_read_pin_flash:1000f114", "ap81_read_pin_flash:004954b0", "ap81_read_config_flash:004953f4", "ap81_read_config_flash:1000f234", "ap81_read_config_flash:00495408", "ap81_write_pin_flash:004954b8", "ap81_write_pin_flash:1000f340", "ap81_write_pin_flash:004954cc", "ap81_write_app_flash_ex:00495448", "ap81_write_app_flash_ex:1000fc64", "ap81_write_app_flash_ex:0049545c", "ap81_write_config_flash:004953d8", "ap81_write_config_flash:1000fe54", "ap81_write_config_flash:004953ec", "ap81_erase_app_flash:00495410", "ap81_erase_app_flash:10010390", "ap81_erase_app_flash:00495424", "ap81_erase_config_flash:004953bc", "ap81_erase_config_flash:10010438", "ap81_erase_config_flash:004953d0", "ap81_read_mac_flash:00495464", "ap81_read_mac_flash:10010730", "ap81_read_mac_flash:00495478", "ap81_write_app_flash:0049542c", "ap81_write_app_flash:10010940", "ap81_write_app_flash:00495440", "flash_capability:%#X\\n:0048b4d8", "The file's length is not suit for flash: %d\\n:0048b598", "get flash para error!:0046ebb4", "pwd_start:get flash para error!:0046ef1c", "Write pin to flash successful:0049000c", "Write pin to flash failed:0049002c", "/tmp/flash_id:004948b4", "erase config flash failed!:00483a1c", "read from flash failed!:00483cd0", "write_to_configflash: ioctl failed:00494a28", "read_from_configflash: open device failed:00494ae8", "/dev/ar7100_flash_chrdev:004949bc", "/dev/ar7100_flash_chrdev:00494ab4", "write_to_configflash: open device failed:004949f4", "read_from_configflash: ioctl failed:00494b1c", "failed to read pin from flash:004869e4"], "reboot": ["rebootRpmsInit:1000f798", "rebootRpmsInit:0045432c", "reboot:0045ec4c", "reboot:0048d158", "rebooting:0046dcd0", "rebootInf:004571b8"], "delivery": []}}}}}
  ```
